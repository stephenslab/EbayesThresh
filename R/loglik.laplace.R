# Functions to compute the log likelihood under the laplace prior
# More numerically stable than the original approach in negloglik.laplace.R

# This is the log of g, which is (2.2) in Kan Xu's MS paper
logg.laplace = function(x,s,a){
  lg1 = -a*x + pnorm((x-s^2*a)/s,log=TRUE)
  lg2 = a*x + pnorm((x+s^2*a)/s,lower.tail = FALSE,log=TRUE)
  lfac = pmax(lg1,lg2) # avoid numeric issues by removing a log factor
  log(0.5) + log(a) + (a^2 * s^2)/2 + lfac + log(exp(lg1-lfac) + exp(lg2-lfac))
}

# return log((1-w)f + wg) as a vector
# deal with case w=1 and w=0 separately for stability
vloglik.laplace = function(x,s,a,w){
  if(w==0){return(dnorm(x,0,s,log=TRUE))} 
  lg = logg.laplace(x,s,a)
  if(w==1){return(lg)}
  
  lf = dnorm(x,0,s,log=TRUE)
  lfac = pmax(lg,lf)
  return(lfac + log((1-w)*exp(lf-lfac) + w*exp(lg-lfac))) 
}

loglik.laplace = function(x,s,a,w){
  sum(vloglik.laplace(x,s,a,w))
}